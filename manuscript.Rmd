---
#title: ""
#author: ""
output:
  bookdown::word_document2:
    reference_docx: template/word_template.docx
    number_sections: false
  bookdown::pdf_book:
bibliography: [references/packages.bib, references/from-zotero.bib]
csl: template/abnt.csl
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
# knitr options
#knitr::opts_chunk$set(
#	echo = FALSE,
#	message = FALSE,
#	warning = FALSE
#)
# Load the package
#devtools::load_all()
```
```{r, include = FALSE}
source("./analysis/StatAnalysis/DataCleaningMutate.R")
source("./analysis/StatAnalysis/ExploratoryAndDescriptiveAnalysis.R")
source("./analysis/StatAnalysis/ModelAnalysis.R")
source("./analysis/useful_functions.R")

```

# TITULO DO PROJETO

**ABSTRACT**:



**KEYWORDS**: 

**Variabilidade espaço-temporal da qualidade da água superficial do Corpo Central I da represa Billings - São Paulo, Brasil**

**RESUMO**:



**PALAVRAS-CHAVE**: 


## INTRODUCTION

## METODOLOGIA

### Aspectos Éticos

Como parte do estudo aprovado pelo Comitê de Ética  em Pesquisa Envolvendo Seres Humanos - CAEE 36189220.3.0000.8527 (“Perfil da população do oeste paranaense acometido de Síndrome Respiratória Agunda Grave entre 2020 a 2022”, Número do Parecer: 4.250.900), realizou-se uma análise comparativa das frequências alélicas em três grupos de pacientes com COVID-19 admitidos no Hospital Municipal Padre Germano Lauck - HMPGL (Foz do Iguaçu, Brasil). O estudo foi patrocinado pela Universidade Federal da Integração Latino-Americana (UNILA), como “Ação 9  de enfrentamento à COVID-19” (PORTARIA No 193/2020/GR) e pelo Conselho Nacional de Desenvolvimento Científico e Tecnológico - CNPq (Número).

### Desenhos do Estudo e Participantes

Os pacientes com COVID-19 admitidos no HMPGL entre agosto à dezembro de 2020 e abril à junho de 2021 (semanas epidemiológicas) tiveram amostras de sangue coletadas. Os pacientes selecionados apresentaram durante a admissão resultado positivo para SARS-CoV-2 por transcrição reversa seguida de reação em cadeia de polimerase em tempo real (RT-qPCR) a partir de coleta  nasofaríngea por swab ou lavagem broncoalveolar, realizado pelo Laboratório de Diagnóstico Molecular - HMPGL. Pacientes que apresentaram algum dos seguintes aspectos não foram incluídos nesse estudo: menores de dezoito anos, estrangeiros, admitidos por outras causas explicitamente não associadas à COVID-19 (i.e. quedas, acidentes, lesões musculares), evasão hospitalar, resultado positivo após um significativo período de internação ou quadro prévio de imunosupressão adicional (i.e. ativo no tratamento quimioterápico para câncer, imunodeficiente, HIV). Além disso, não foram incluídos pacientes de 2021 que foram readmitidos por quadro de COVID-19. 
O perfil e quadro clínico de cada paciente foram coletados  pelo prontuários do Sistema de Gestão Tasy (Koninklijke Philips N.V, Inc., Amsterdam, NL).  As coletas de ambos os anos foram subdivididos baseados no desfecho: índividuos admitidos na UTI que receberam alta hospitalar (Alta-20 para amostragem de 2020, Alta-21 para amostragem de 2021) ou que faleceDesenhos do Estudo e Participantes

Os pacientes com COVID-19 admitidos no HMPGL entre agosto à dezembro de 2020 e abril à junho de 2021 (semanas epidemiológicas) tiveram amostras de sangue coletadas. Os pacientes selecionados apresentaram durante a admissão resultado positivo para SARS-CoV-2 por transcrição reversa seguida de reação em cadeia de polimerase em tempo real (RT-qPCR) a partir de coleta  nasofaríngea por swab ou lavagem broncoalveolar, realizado pelo Laboratório de Diagnóstico Molecular - HMPGL. Pacientes que apresentaram algum dos seguintes aspectos não foram incluídos nesse estudo: menores de dezoito anos, estrangeiros, admitidos por outras causas explicitamente não associadas à COVID-19 (i.e. quedas, acidentes, lesões musculares), evasão hospitalar, resultado positivo após um significativo período de internação ou quadro prévio de imunosupressão adicional (i.e. ativo no tratamento quimioterápico para câncer, imunodeficiente, HIV). Além disso, não foram incluídos pacientes de 2021 que foram readmitidos por quadro de COVID-19. 
O perfil e quadro clínico de cada paciente foram coletados  pelo prontuários do Sistema de Gestão Tasy (Koninklijke Philips N.V, Inc., Amsterdam, NL).  As coletas de ambos os anos foram subdividos baseados no desfecho: índividuos admitidos na UTI que receberam alta hospitalar (Alta-20 para amostragem de 2020, Alta-21 para amostragem de 2021) ou que faleceram (Óbito-20 para amostragem de 2020, Óbito-21 para amostragem de 2021). Durante a internação foram coletados cerca de 6 ml de sangue periférico em tubo (Tubo Greiner Bio-One) contendo o anticoagulante ácido etilenodiamino tetra-acético (EDTA), centrifugados e armazenados em refrigeração - 80 ͦ C.
O grupo controle para análises de frequências alélicas foi estabelecido com o Allele Frequency Net Database, a partir dos dados do Registro Nacional de Doadores de Médula Óssea - Paraná (REDOME-Paraná) [@gonzalez-galarza_allele_2020 ; @wu_structural_2022].


### Analysis

The analysis and visualization of data and statistical analysis were performed using the R software (*https://www.r-project.org/*) [@R-software]. R Packages used in this research are available on the Comprehensive R Archive Network (CRAN).


## RESULTS AND DISCUSSION

```{r,results="asis"}

summary_table_final %>% 
  flextable::theme_vanilla()

```
```{r}


Redome_freq <- control_freq_redome %>%
  rename(Freq = "allele_frequency") %>%
  mutate(n_Redome = round(as.numeric(Freq) * (2*(as.numeric(gsub(",","",sample_size)))),0)) %>%
  dplyr::select("allele", "Freq", "n_Redome")

allele_freq <- data_final %>%
  dplyr::select(allele1, allele2, Outcome_icu, SamplesGroupYear, SamplesGroup) %>%
  dplyr::mutate(Outcome_icu = ifelse(Outcome_icu =="Óbito", 'Obito',  "Alta")) %>%
  tidyr::gather(., "Name", "allele",1:2)


allele_freqyears <- frequencer(allele_freq, "SamplesGroupYear", Redome_freq)

allele_freqgrouped <- frequencer(allele_freq, "SamplesGroup", Redome_freq)

allele_freqoutcome<- frequencer(allele_freq, "Outcome_icu", Redome_freq)

stat_alleleyears <- stats(data_final, "SamplesGroupYear", Redome_freq)

stat_alleleoutcome <- stats(data_final, "Outcome_icu", Redome_freq)

stat_allelegrouped<- stats(data_final, "SamplesGroup", Redome_freq)

stat_all <-  cbind(stat_alleleyears["allele"],
                   stat_alleleoutcome["n_Redome"],
                   stat_alleleyears["n_2020"],
                   stat_alleleyears["n_2021"],
                   stat_allelegrouped["n_Alta20"],
                   stat_allelegrouped["n_Alta21"],
                   stat_allelegrouped["n_Óbito20"],
                   stat_allelegrouped["n_Óbito21"],
                   stat_alleleoutcome["n_Alta"],
                   stat_alleleoutcome["n_Óbito"])
  
alleles_MAF <- stat_alleleyears %>%
  mutate_all(~replace(., is.na(.), 0)) %>%
  filter(allele_frequency_2020 < 0.01 | allele_frequency_2021 < 0.01 | Freq < 0.05 | n_2021 < 6 | n_2020 < 6)
MAF <- alleles_MAF$allele
oi <- rbind(fisher_tester(stat_all, groups = c("Redome", "2021","2020")),
fisher_tester(stat_all, groups = c("Redome", "Alta20", "Óbito20", "Alta21", "Óbito21")))

```

```{r fig.width=7, fig.height=10, include = FALSE}




```

```{r fig.width=7, fig.height=10, echo=FALSE}

g.mid<-ggplot(allele_freqoutcome, aes(x=1,y=allele))+
  geom_text(aes(label=allele), size = 4, color = "black", 
            fontface = ifelse(
              allele_freqoutcome$allele %in% alleles_MAF$allele, "plain", "bold")) +
  geom_segment(aes(x=0.95,xend=0.96,yend=allele))+
  geom_segment(aes(x=1.04,xend=1.05,yend=allele))+
  ggtitle("")+
  ylab(NULL)+
  scale_x_continuous(expand=c(0,0),limits=c(0.94,1.065))+
  theme(axis.title.x = element_text(size = 11),
        panel.grid=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.background=element_blank(),
        axis.text.x=element_text(color=NA),
        axis.ticks.x=element_line(color=NA),
        plot.margin = unit(c(0,-1,1,-1), "mm"))+
  xlab("Frequência \n Relativa (%)")

pattern_theme <- 
  theme_bw()+
  theme(
    panel.grid.minor = element_blank(), # No minor grid lines
    panel.grid.major.x = element_blank(), # No major x-axis grid lines
    panel.grid.major.y = element_blank(),
    legend.position = c(0.55, 0.95),
    legend.direction="vertical",
    legend.title = element_blank(),
    #legend.box.background = element_rect(size = 0.2), # Box for legend
    legend.key.size = unit(4, unit = 'mm'),
    legend.text = element_text(size = 8),
    axis.title.x = element_blank(), 
    axis.title.y = element_blank(), 
    axis.text.y = element_blank(), 
    axis.ticks.y = element_blank())


allele_freq_graph1 <- allele_freqyears %>%
  ggplot(aes(y = Freq, x = allele, fill = factor(SamplesGroupYear))) +
  geom_bar(width = 0.8, position = position_dodge(0.8, preserve = "single"), stat = "identity",colour = "black")+
  geom_hline(aes(yintercept = 0.05), linetype = "dashed", size = 0.6) + # Dashed line at y = 1
  scale_fill_manual(values=c(gradient_orange[6], gradient_orange[8], gradient_grey[4]))+ 
  pattern_theme +
  theme(axis.title.x = element_blank(), 
        axis.title.y = element_blank(), 
        axis.text.y = element_blank(), 
        axis.ticks.y = element_blank(), 
        plot.margin = unit(c(1,1.1,1,0), "mm")) +
  scale_y_reverse(expand = c(0,0),limits = c(0.2,0)) +
  coord_flip() +
  ggtitle('A')

allele_freq_graph2 <- allele_freqoutcome %>%
  ggplot(aes(y = Freq, x = allele, fill = factor(Outcome_icu))) +
  geom_bar(width = 0.8, position = position_dodge(0.8, preserve = "single"), stat = "identity",colour = "black")+
  scale_y_continuous(expand = c(0, 0), limits = c(0,0.2)) +
  scale_fill_manual(values=c(gradient_purple[6], gradient_purple[8], gradient_grey[4]))+ 
  pattern_theme +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(), 
        axis.text.y = element_blank(), axis.ticks.y = element_blank(),
        plot.margin = unit(c(1,1,1,-1), "mm"))+
  coord_flip() 

plotfreq1 <- (allele_freq_graph1 + g.mid + allele_freq_graph2) + 
  patchwork::plot_layout(ncol = 3, widths = c(3/9,3/9,3/9))

allele_freq_graph3 <- allele_freqgrouped %>%
  filter(SamplesGroup %in% c("Alta20", "Óbito20", "Redome")) %>% 
  ggplot(aes(y = Freq, x = allele, fill = factor(SamplesGroup))) +
  geom_bar(width = 0.8, position = position_dodge(0.8, preserve = "single"), stat = "identity",colour = "black")+
  scale_fill_manual(values=c(gradient_orange[6], gradient_orange[8], gradient_grey[4]))+ 
  pattern_theme +
  theme(plot.margin = unit(c(1,1.1,1,0), "mm")) +
  scale_y_reverse(expand = c(0,0),limits = c(0.2,0))+
  coord_flip() +
  ggtitle('B')

allele_freq_graph4 <- allele_freqgrouped %>%
  filter(SamplesGroup %in% c("Alta21", "Óbito21", "Redome")) %>%
  ggplot(aes(y = Freq, x = allele, fill = factor(SamplesGroup))) +
  geom_bar(width = 0.8, position = position_dodge(0.8, preserve = "single"), stat = "identity",colour = "black")+
  scale_y_continuous(expand = c(0, 0), limits = c(0,0.2)) +
  scale_fill_manual(values=c(gradient_purple[6], gradient_purple[8], gradient_grey[4]))+ 
  pattern_theme +
  theme(plot.margin = unit(c(1,1,1,-1), "mm"))+
  coord_flip()


plotfreq2 <- (allele_freq_graph3 + g.mid + allele_freq_graph4) + 
  patchwork::plot_layout(ncol = 3, widths = c(3/9,3/9,3/9)) 







plotfreq <- (plotfreq1 | plot_spacer() | plotfreq2)  + plot_layout(widths = c(4, 0.05 ,4)) 

png("images/frequencies.png", width = 7, height = 10, units = 'in', res = 300)
plotfreq
dev.off()

knitr::include_graphics("images/frequencies.png")


```

```{r cars-plot, dev='png', fig.show='hide'}

selvar <-
  list(Age = "Idade",
       sex = "Sexo",
       smok_bv = "Tabag." ,
       BacCoinfec = "Coinf. \n Bac.",
       HospitalPeriod_days = "Dias \n de \n Internação",
       ICU_days = "Dias \n de UTI",
       VentilatorySupport_days = "Suporte. \n Vent.",
       FirstSymptons_days = "Primeiros \n Sintomas",
       SamplesGroupYear = "Ano \n de Coleta",
       Outcome_icu = "Desfecho",
       sum_comorb = "Núm. de \n Comorb.",
       allele1 = "allele1",
       allele2 = "allele2")

cor_dataset <- transform_data(data_final, selvar, type = "corr")
corr_ab <- corr_values("SamplesGroupYear",designmatrix = cor_dataset)
corr_c <- corr_values(designmatrix = cor_dataset)

png("images/correlation.png", width = 10, height = 3, units = 'in', res = 300)
  par(mfrow = c(1,3), xpd = NA)
  corr_plots(corr_ab$`2020`, selvar, gradient_purple)
  addfiglab("A")
  corr_plots(corr_ab$`2021`, selvar, gradient_orange)
  addfiglab("B")
  corr_plots(corr_c, selvar, gradiente_diverg)
  addfiglab("C")
dev.off()

knitr::include_graphics("images/correlation.png")

```
![A nice plot.](`r knitr::fig_chunk('cars-plot', 'png')`)


```{r echo=FALSE}
#Data for logistic regression
logit_dataset <- transform_data(data_final, selvar, type = "lreg")
logit_dataset
#outcome/years
logit20 <- logiting(logit_dataset, year = 2020, "Outcome_icu", model = "additive")
logit21 <- logiting(logit_dataset, year = 2021, "Outcome_icu", model = "additive")
logit20adj <- logiting(logit_dataset, year = 2020, "Outcome_icu", CoVars = "Age", model = "additive")
logit21adj <- logiting(logit_dataset, year = 2021, "Outcome_icu", CoVars = "Age", model = "additive")


#between years
logityear <- logiting(logit_dataset, "SamplesGroupYear", model = "additive")
logityearadj <- logiting(logit_dataset, "SamplesGroupYear", CoVars = "Age", model = "additive")


write.xlsx(logit20, file="results/logisticregression.xlsx", sheetName="outcome2020", row.names=FALSE)
write.xlsx(logit21, file="results/logisticregression.xlsx", sheetName="outcome2021", append=TRUE, row.names=FALSE)
write.xlsx(logit20adj, file="results/logisticregression.xlsx", sheetName="outcome2020adj", append=TRUE, row.names=FALSE)
write.xlsx(logit21adj, file="results/logisticregression.xlsx", sheetName="outcome2021adj", append=TRUE, row.names=FALSE)
write.xlsx(logityear, file="results/logisticregression.xlsx", sheetName="2020-2021", append=TRUE, row.names=FALSE)
write.xlsx(logityearadj, file="results/logisticregression.xlsx", sheetName="2020-2021adj", append=TRUE, row.names=FALSE)
```
```{r}

#Datasets
glm_dataset <- transform_data(data_final, selvar,type = "glm")

## Split 2020 & 2021
glm_dataset0 <- glm_dataset[glm_dataset$SamplesGroupYear == "2020",] 
glm_dataset1 <- glm_dataset[glm_dataset$SamplesGroupYear == "2021",]
glm_dataset0

#MODELS
#2020
glmmod0 <-  MASS:::glm.nb(ICU_days ~ allele, data = glm_dataset0)
#2021
glmmod1 <-  MASS:::glm.nb(ICU_days ~ allele , data = glm_dataset1)
#Interaction
glmmodint <- MASS:::glm.nb(ICU_days ~ allele*SamplesGroupYear, data = glm_dataset)
#Interaction age-adjusted
glmmodintadj <- MASS:::glm.nb(ICU_days ~ allele + SamplesGroupYear +  Age + allele:SamplesGroupYear + Age*(allele:SamplesGroupYear), data = glm_dataset)

#Responses
response0 <- glm_emm(glmmod0, glm_dataset0, "allele")
response1 <- glm_emm(glmmod1, glm_dataset1, "allele")
responseint <- glm_emm(glmmodint, glm_dataset, c("allele", "SamplesGroupYear"))
responseintadj <- glm_emm(glmmodintadj, glm_dataset, c("allele", "SamplesGroupYear"))

#Effect Ratio
#Effect alone = Ratio between allele mean and the all alleles' mean
#Effect ratio = ratio between two factors
effect_rat0 <- glm_effect_rat(response0)
effect_rat1 <- glm_effect_rat(response1)
effect_ratint <- glm_effect_rat(responseint) 
effect_ratintadj <- glm_effect_rat(responseintadj)

#Plot Effects
plot_eff0 <- plot_effects(effect_rat0, "Razão de Taxa de Incidência", 0.06)
plot_eff1 <- plot_effects(effect_rat1, "Razão de Taxa de Incidência", 0.5)


#Plot Responses
plot_res0 <- plot_response(dataraw = glm_dataset0, 
                           data_emm = response0,
                           y_var = "ICU_days",
                           palette = "Oranges", 
                           ylabel = "Dias de UTI",
                           legendtitle = "Idade")

plot_res1 <- plot_response(dataraw = glm_dataset1, 
                           data_emm = response1,
                           y_var = "ICU_days",
                           palette = "Oranges", 
                           ylabel = "Dias de UTI",
                           legendtitle = "Idade")

plot_resint <- plot_response_int(dataraw = glm_dataset, 
                                 data_emm = responseint, 
                                 y_var = "ICU_days", 
                                 ylabel = "Dia de UTI", 
                                 legendtitle = "Ano de Coleta")

plot_resint

```
## REFERENCES

```{r echo=FALSE}
 #knitr::write_bib(c('knitr', 'rmarkdown',  'pagedown', "tidyverse", "factoextra", "flextable", "SciViews", "vegan", "STI", "ggplot2", "adespatial", "patchwork", "dplyr", "stats"), 'references/packages.bib')

 #knitr::write_bib(c("dplyr"), 'references/packages.bib')
```

```{=html}
<!-- This '<div id="refs"></div>' needs to 
be here if you have appendix pages 
otherwise you can remove it.-->
```
```{r}

```

<br>
<div id="refs"></div>
<br>

##APÊNDICE

### Análise Exploratória

```{r echo = FALSE}




```




```{r echo = FALSE}



```

```{r}

glmmod0adj <-  MASS:::glm.nb(ICU_days ~ allele + Age, data = glm_dataset0)
glmmod1adj <-  MASS:::glm.nb(ICU_days ~ allele + Age, data = glm_dataset1)

glmmod0_est <- cbind(coef(summary(glmmod0)), confint(glmmod0))
glmmod0adj_est <- cbind(coef(summary(glmmod0adj)), confint(glmmod0adj))

glmmod1_est <- cbind(coef(summary(glmmod1)), confint(glmmod1))
glmmod1adj_est <- cbind(coef(summary(glmmod1adj)), confint(glmmod1adj))

```

